version: "2.4"
services:
  i2b2:
    image: ${I2B2_DOCKER_TAG:?}
    build:
      context: ../build/package/i2b2
    environment:
      - I2B2_DB_HOST=postgresql
      - I2B2_DB_PORT=5432
      - I2B2_DB_USER=i2b2
      - I2B2_DB_PW=changeme
      - I2B2_DB_NAME=i2b2medco
      - WILDFLY_ADMIN_PASSWORD=changeme
      - I2B2_DOMAIN_NAME=i2b2medco
      - I2B2_SERVICE_PASSWORD=changeme
      - DEFAULT_USER_PASSWORD=changeme
      - AXIS2_LOGLEVEL=INFO

  medco-unlynx:
    image: ${MEDCO_DOCKER_TAG:?}
    build:
      context: ../
      dockerfile: build/package/medco/Dockerfile
    entrypoint: docker-entrypoint.sh medco-unlynx
    environment:
      - MEDCO_NODE_IDX=0
      - UNLYNX_DEBUG_LEVEL=1
    volumes:
      - ./dev-local-3nodes/configuration:/medco-configuration

  medco-unlynx-wstunnel:
    image: ${WSTUNNEL_DOCKER_TAG:?}
    build:
      context: ../build/package/wstunnel
    environment:
      - SERVER_LISTEN_URL=ws://0.0.0.0:2003
      - SERVER_DEST_ADDRESS=medco-unlynx:2001
      - CLIENTS_LISTEN_ADDRESSES=0.0.0.0:3000,0.0.0.0:3001,0.0.0.0:3002
      - CLIENTS_WS_SERVER_URLS=wss://nginx:443,wss://nginx:443,wss://nginx:443
      - CLIENTS_WS_SERVER_PATH_PREFIXES=local-3nodes/wstunnel-unlynx-0,local-3nodes/wstunnel-unlynx-1,local-3nodes/wstunnel-unlynx-2
      - CLIENTS_DEST_ADDRESSES=medco-unlynx-srv0:2001,medco-unlynx-srv1:2003,medco-unlynx-srv2:2005
    volumes:
      - ./dev-local-3nodes/configuration:/medco-configuration

  nginx:
    image: ${NGINX_DOCKER_TAG:?}
    build:
      context: ../build/package/nginx
    environment:
      - ALL_TIMEOUTS_SECONDS=600
      - PROD_CONFIG=false
    volumes:
      - ../build/package/nginx/www-data:/www-data
      - ../build/package/nginx/conf.d:/etc/nginx/conf.d

  postgresql:
    image: ${PG_DOCKER_TAG:?}
    environment:
      - POSTGRES_PASSWORD=changeme
      - DB_ALL_USERS_PASSWORD=changeme
    volumes:
      - medcodb:/var/lib/postgresql/data
      - ../build/package/postgresql/initdb-data:/docker-entrypoint-initdb.d

  pg-admin:
    image: ${PGADMIN_TAG:?}
    build:
      context: ../build/package/pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin
      - PGADMIN_DEFAULT_PASSWORD=changeme
    logging:
      driver: none

  keycloak:
    image: ${KEYCLOAK_DOCKER_TAG:?}
    build:
      context: ../build/package/keycloak
    environment:
      - KEYCLOAK_USER=keycloak
      - KEYCLOAK_PASSWORD=changeme
      - DB_VENDOR=postgres
      - DB_ADDR=postgresql
      - DB_PORT=5432
      - DB_DATABASE=keycloak
      - DB_USER=keycloak
      - DB_PASSWORD=changeme

  glowing-bear-medco:
    image: ${GB_DOCKER_TAG:?}
    environment:
      - GB_MEDCO_NODE_URL=https://localhost/local-3nodes/medco-0
      - GB_KEYCLOAK_URL=https://localhost/auth
      - GB_KEYCLOAK_REALM=master
      - GB_KEYCLOAK_CLIENT_ID=medco
      - GB_FOOTER_TEXT=

  medco-connector:
    image: ${MEDCO_DOCKER_TAG:?}
    build:
      context: ../
      dockerfile: build/package/medco/Dockerfile
    entrypoint: docker-entrypoint.sh medco-connector-server
    ports:
      - "1999"
    environment:
      - SERVER_HTTP_WRITE_TIMEOUT_SECONDS=600
      - I2B2_HIVE_URL=http://i2b2:8080/i2b2/services
      - I2B2_LOGIN_DOMAIN=i2b2medco
      - I2B2_LOGIN_PROJECT=MedCo
      - I2B2_LOGIN_USER=medcouser
      - I2B2_LOGIN_PASSWORD=changeme
      - I2B2_WAIT_TIME_SECONDS=450
      - I2B2_ONT_MAX_ELEMENTS=200
      - LOG_LEVEL=3
      - UNLYNX_GROUP_FILE_PATH=/medco-configuration/group.toml
      - UNLYNX_TIMEOUT_SECONDS=150
      - OIDC_JWKS_URLS=http://keycloak:8080/auth/realms/master/protocol/openid-connect/certs
      - OIDC_JWT_ISSUERS=https://localhost/auth/realms/master
      - OIDC_CLIENT_IDS=medco
      - OIDC_JWT_USER_ID_CLAIMS=preferred_username
      - OIDC_JWKS_TIMEOUT_SECONDS=30
      - MEDCO_OBFUSCATION_MIN=5
      - MEDCO_NODES_URL=https://localhost/local-3nodes/medco-0,https://localhost/local-3nodes/medco-1,https://localhost/local-3nodes/medco-2
      - MEDCO_NODE_IDX=0
      - MC_DB_HOST=postgresql
      - MC_DB_PORT=5432
      - MC_DB_USER=medcoconnector
      - MC_DB_PASSWORD=changeme
      - MC_DB_NAME=medcoconnector
      - I2B2_DB_HOST=postgresql
      - I2B2_DB_PORT=5432
      - I2B2_DB_USER=i2b2
      - I2B2_DB_PASSWORD=changeme
      - I2B2_DB_NAME=i2b2medco
    volumes:
      - ./dev-local-3nodes/configuration:/medco-configuration

  medco-cli-client:
    image: ${MEDCO_DOCKER_TAG:?}
    build:
      context: ../
      dockerfile: build/package/medco/Dockerfile
    entrypoint: docker-entrypoint.sh medco-cli-client
    environment:
      - LOG_LEVEL=3
      - UNLYNX_GROUP_FILE_PATH=/medco-configuration/group.toml
      - MEDCO_NODE_IDX=0
      - CLIENT_SEARCH_TIMEOUT_SECONDS=10
      - CLIENT_QUERY_TIMEOUT_SECONDS=660
      - QUERY_TOOLS_TIMEOUT_SECONDS=10
      - SURVIVAL_ANALYSIS_TIMEOUT_SECONDS=300
      - TOKEN_TIMEOUT_SECONDS=10
      - WAIT_TICK_SECONDS=5
      - CLIENT_GENOMIC_ANNOTATIONS_QUERY_TIMEOUT_SECONDS=10
      - MEDCO_CONNECTOR_URL=https://localhost/local-3nodes/medco-0
      - OIDC_REQ_TOKEN_URL=https://localhost/auth/realms/master/protocol/openid-connect/token
      - OIDC_REQ_TOKEN_CLIENT_ID=medco
    volumes:
      - ./dev-local-3nodes/configuration:/medco-configuration
      - ./:/data
    network_mode: host

  medco-loader:
    image: ${MEDCO_DOCKER_TAG:?}
    build:
      context: ../
      dockerfile: build/package/medco/Dockerfile
    entrypoint: docker-entrypoint.sh medco-loader
    environment:
      - LOG_LEVEL=3
      - UNLYNX_GROUP_FILE_PATH=/medco-configuration/group.toml
      - MEDCO_NODE_IDX=0
      - I2B2_DB_HOST=localhost
      - I2B2_DB_PORT=5432
      - I2B2_DB_NAME=i2b2medco
      - I2B2_DB_USER=i2b2
      - I2B2_DB_PASSWORD=changeme
      - MC_DB_HOST=localhost
      - MC_DB_PORT=5432
      - MC_DB_NAME=medcoconnector
      - MC_DB_USER=medcoconnector
      - MC_DB_PASSWORD=changeme
    volumes:
      - ./dev-local-3nodes/configuration:/medco-configuration
      - ../test/data:/data
    network_mode: host
