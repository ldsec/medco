version: '3.5'
services:
  medco-connector:
    image: medco/medco-connector:dev
    build:
      context: ../
      dockerfile: deployment/Dockerfile
    ports:
      - "1999"
    environment:
      - SERVER_HTTP_WRITE_TIMEOUT_SECONDS=600
      - I2B2_HIVE_URL=http://i2b2:8080/i2b2/services
      - I2B2_LOGIN_DOMAIN=i2b2medco
      - I2B2_LOGIN_PROJECT=MedCo
      - I2B2_LOGIN_USER=e2etest
      - I2B2_LOGIN_PASSWORD=e2etest
      - I2B2_WAIT_TIME_SECONDS=300
      - LOG_LEVEL=5
      - UNLYNX_GROUP_FILE_PATH=/medco-configuration/group.toml
      - UNLYNX_TIMEOUT_SECONDS=300
      - OIDC_JWKS_URLS=http://keycloak:8080/auth/realms/master/protocol/openid-connect/certs
      - OIDC_JWT_ISSUERS=http://keycloak:8080/auth/realms/master
      - OIDC_CLIENT_IDS=medco
      - OIDC_JWT_USER_ID_CLAIMS=preferred_username
      - OIDC_JWKS_TIMEOUT_SECONDS=30
      - MEDCO_OBFUSCATION_MIN=5
      - MEDCO_NODES_URL=http://medco-connector-srv0/medco,http://medco-connector-srv1/medco,http://medco-connector-srv2/medco
      - MEDCO_NODE_IDX=0
      - MC_DB_HOST=postgresql
      - MC_DB_PORT=5432
      - MC_DB_USER=medcoconnector
      - MC_DB_PW=medcoconnector
      - MC_DB_NAME=mcsrv
    volumes:
      - ./configuration-profile:/medco-configuration

  medco-cli-client:
    image: medco/medco-cli-client:dev
    build:
      context: ../
      dockerfile: deployment/client.Dockerfile
    environment:
      - LOG_LEVEL=5
      - UNLYNX_GROUP_FILE_PATH=/medco-configuration/group.toml
      - MEDCO_NODE_IDX=0
      - CLIENT_QUERY_TIMEOUT_SECONDS=660
      - CLIENT_GENOMIC_ANNOTATIONS_QUERY_TIMEOUT_SECONDS=10
      - MEDCO_CONNECTOR_URL=http://medco-connector-srv0/medco
      - OIDC_REQ_TOKEN_URL=http://localhost/auth/realms/master/protocol/openid-connect/token
      - OIDC_REQ_TOKEN_CLIENT_ID=medco
    volumes:
      - ~/MedCo/repositories/medco-deployment/configuration-profiles/dev-local-3nodes:/medco-configuration
    network_mode: host
    command: >-
      todo: default e2e query command;
